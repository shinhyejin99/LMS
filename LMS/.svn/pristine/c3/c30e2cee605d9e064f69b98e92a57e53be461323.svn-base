<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
 * == 개정이력(Modification Information) ==
 *
 *   수정일         수정자     수정내용
 *  ============  =========  ===========================================
 *  2025. 10. 20.  정태일      최초 생성, 강의시간표 조회 쿼리 추가
 *  2025. 10. 21.  정태일      전반 정리/주석 보강, selectFacility에 USING_YN 조건 추가
 *  2025. 10. 29.  정태일      특정 건물 좋회  기능 추가
 *
 -->

<mapper namespace="kr.or.jsu.mybatis.mapper.PortalFacilityMapper">

    <!--
        시설 단건 조회
        - 설명: 시설 코드(placeCd)로 활성(USING_YN='Y') 시설 1건을 조회합니다.
        - 파라미터: #{placeCd} (String)
        - 결과 매핑: kr.or.jsu.vo.PlaceVO
        - 비고: 단건 상세 조회 목적. USING_YN 조건을 추가하여 비활성 시설은 제외합니다.
     -->
    <select id="selectFacility" resultType="kr.or.jsu.vo.PlaceVO">
        SELECT
              PLACE_CD       AS placeCd
            , PLACE_NAME     AS placeName
            , CAPACITY       AS capacity
            , PLACE_TYPE_CD  AS placeTypeCd
            , PLACE_USAGE_CD AS placeUsageCd
        FROM
              PLACE
        WHERE
              USING_YN = 'Y'
          AND PLACE_CD = #{placeCd}
    </select>

 <!--
        특정 용도의 시설 목록 조회
        - 설명: 사용 가능(USING_YN='Y')이면서 주어진 용도 코드(placeUsageCd)에 해당하는 시설 목록을 조회합니다.
        - 파라미터: #{placeUsageCd} (String)
        - 결과 매핑: kr.or.jsu.vo.PlaceVO (다건)
     -->
<!--     <select id="selectPlacesByUsage" resultType="kr.or.jsu.vo.PlaceVO"> -->
<!--         SELECT -->
<!--               PLACE_CD       AS placeCd -->
<!--             , PLACE_NAME     AS placeName -->
<!--             , CAPACITY       AS capacity -->
<!--             , PLACE_TYPE_CD  AS placeTypeCd -->
<!--             , PLACE_USAGE_CD AS placeUsageCd -->
<!--         FROM -->
<!--               PLACE -->
<!--         WHERE -->
<!--               USING_YN = 'Y' -->
<!--           AND PLACE_USAGE_CD = #{placeUsageCd} -->
<!--     </select> -->

<!--
        사용 가능한 모든 건물 목록 조회
        - 설명: PLACE_TYPE_CD가 'BUILDING'이고 활성(USING_YN='Y')인 모든 건물 목록을 조회합니다.
        - 파라미터: 없음
        - 결과 매핑: kr.or.jsu.vo.PlaceVO (다건)
    -->
    <select id="selectBuildings" resultType="kr.or.jsu.vo.PlaceVO">
        SELECT
              PLACE_CD       AS placeCd
            , PLACE_NAME     AS placeName
            , CAPACITY       AS capacity
            , PLACE_TYPE_CD  AS placeTypeCd
            , PLACE_USAGE_CD AS placeUsageCd
        FROM
              PLACE
        WHERE
              USING_YN = 'Y'
          AND PLACE_TYPE_CD = 'BUILDING'
    </select>

    <!--
        특정 건물 내의 시설 유형 목록 조회
        - 설명: 주어진 건물 코드(parentCd) 내의 활성(USING_YN='Y') 시설들의 고유한 용도 코드와 해당 이름을 조회합니다.
        - 파라미터: #{parentCd} (String)
        - 결과 매핑: Map<String, String> (COMMON_CD, CD_NAME)
    -->
    <select id="selectFacilityTypesByBuilding" resultType="map">
        SELECT DISTINCT
              P.PLACE_USAGE_CD AS commonCd
            , CC.CD_NAME       AS cdName
        FROM
              PLACE P
        JOIN
              COMMON_CODE CC ON P.PLACE_USAGE_CD = CC.COMMON_CD
        WHERE
              P.PARENT_CD = #{parentCd}
          AND P.PLACE_TYPE_CD IN ('ROOM', 'FACILITY')
          AND P.USING_YN = 'Y'
          AND P.PLACE_USAGE_CD != 'ADMIN_OFFICE'
        <if test="isStudent">
            AND P.PLACE_USAGE_CD != 'CLASSROOM'
        </if>
    </select>

    <!--
        특정 건물 및 시설 유형에 해당하는 시설 목록 조회
        - 설명: 주어진 건물 코드(parentCd)와 시설 용도 코드(placeUsageCd)에 해당하는 활성(USING_YN='Y') 시설 목록을 조회합니다.
        - 파라미터:
            #{parentCd} (String)
            #{placeUsageCd} (String)
        - 결과 매핑: kr.or.jsu.vo.PlaceVO (다건)
    -->
    <select id="selectTotalFacilitiesByBuildingAndType" resultType="int">
        SELECT COUNT(*)
        FROM PLACE P
        <where>
            P.PARENT_CD = #{parentCd}
            AND P.PLACE_TYPE_CD IN ('ROOM', 'FACILITY')
            AND P.USING_YN = 'Y'
            AND P.PLACE_USAGE_CD = #{placeUsageCd}
            AND P.PLACE_USAGE_CD != 'ADMIN_OFFICE'
            <if test="isStudent">
                AND P.PLACE_USAGE_CD != 'CLASSROOM'
            </if>
        </where>
    </select>

    <select id="selectFacilitiesByBuildingAndType" resultType="kr.or.jsu.vo.PlaceVO">
        SELECT
              PLACE_CD       AS placeCd
            , PLACE_NAME     AS placeName
            , CAPACITY       AS capacity
            , PLACE_TYPE_CD  AS placeTypeCd
            , PLACE_USAGE_CD AS placeUsageCd
        FROM (
            SELECT
                ROWNUM AS RNUM,
                inner_query.*
            FROM (
                SELECT
                      PLACE_CD
                    , PLACE_NAME
                    , CAPACITY
                    , PLACE_TYPE_CD
                    , PLACE_USAGE_CD
                FROM
                      PLACE P
                <where>
                      USING_YN = 'Y'
                  AND PARENT_CD = #{parentCd}
                  AND PLACE_USAGE_CD = #{placeUsageCd}
                  AND PLACE_USAGE_CD != 'ADMIN_OFFICE'
                <if test="isStudent">
                    AND P.PLACE_USAGE_CD != 'CLASSROOM'
                </if>
                </where>
                ORDER BY PLACE_CD
            ) inner_query
            WHERE ROWNUM &lt;= #{paginationInfo.endRow}
        )
        WHERE RNUM &gt;= #{paginationInfo.startRow}
    </select>

    <!--
        특정 건물에 속한 모든 시설 목록 조회
        - 설명: 주어진 건물 코드(parentCd)에 해당하는 활성(USING_YN='Y') 시설 목록을 조회합니다.
        - 파라미터: #{parentCd} (String)
        - 결과 매핑: kr.or.jsu.vo.PlaceVO (다건)
    -->
    <select id="selectTotalFacilitiesByBuilding" resultType="int">
        SELECT
              COUNT(PLACE_CD)
        FROM
              PLACE P
        <where>
              USING_YN = 'Y'
          AND PARENT_CD = #{parentCd}
          AND PLACE_TYPE_CD != 'BUILDING'
          AND P.PLACE_USAGE_CD != 'ADMIN_OFFICE'
        <if test="isStudent">
            AND P.PLACE_USAGE_CD != 'CLASSROOM'
        </if>
        </where>
    </select>

    <select id="selectFacilitiesByBuilding" resultType="kr.or.jsu.vo.PlaceVO">
        SELECT
              PLACE_CD       AS placeCd
            , PLACE_NAME     AS placeName
            , CAPACITY       AS capacity
            , PLACE_TYPE_CD  AS placeTypeCd
            , PLACE_USAGE_CD AS placeUsageCd
        FROM (
            SELECT
                ROWNUM AS RNUM,
                inner_query.*
            FROM (
                SELECT
                      PLACE_CD
                    , PLACE_NAME
                    , CAPACITY
                    , PLACE_TYPE_CD
                    , PLACE_USAGE_CD
                FROM
                      PLACE P
                <where>
                      USING_YN = 'Y'
                  AND PARENT_CD = #{parentCd}
                  AND PLACE_TYPE_CD != 'BUILDING'
                  AND P.PLACE_USAGE_CD != 'ADMIN_OFFICE'
                <if test="isStudent">
                    AND P.PLACE_USAGE_CD != 'CLASSROOM'
                </if>
                </where>
                ORDER BY PLACE_CD
            ) inner_query
            WHERE ROWNUM &lt;= #{paginationInfo.endRow}
        )
        WHERE RNUM &gt;= #{paginationInfo.startRow}
    </select>
    
    <!--
        일반 예약 현황(기간 겹침) 조회
        - 설명: 특정 시설(placeCd)에 대해 주어진 기간(startAt ~ endAt)과 겹치는 예약을 조회합니다.
                취소되지 않은(CANCEL_YN='N') 예약만 대상입니다.
        - 파라미터:
            #{placeCd}        (String)
            #{startAt}        (TIMESTAMP/DATE)  조회 시작 시각
            #{endAt}          (TIMESTAMP/DATE)  조회 종료 시각
            #{currentUserId}  (String)          로그인 사용자 ID (본인 예약 식별용)
        - 결과 매핑: kr.or.jsu.vo.UserReserveVO (다건)
        - 기간 겹침 조건:
            (UR.START_AT < :endAt) AND (UR.END_AT > :startAt)
        - 비고: 본인 예약이 아닌 경우 userId는 NULL, userName은 '다른 사용자'로 마스킹됩니다.
     -->
    <select id="selectReservationsByDateRange" resultType="kr.or.jsu.vo.UserReserveVO">
        SELECT
              UR.RESERVE_ID     AS reserveId
            , UR.PLACE_CD       AS placeCd
            , UR.RESERVE_REASON AS reserveReason
            , UR.CREATE_AT      AS createAt
            , UR.START_AT       AS startAt
            , UR.END_AT         AS endAt
            , UR.HEADCOUNT      AS headcount
            , UR.CANCEL_YN      AS cancelYn
            , CASE
                WHEN UR.USER_ID = #{currentUserId} THEN UR.USER_ID
                ELSE NULL
              END               AS userId
            , CASE
                WHEN UR.USER_ID = #{currentUserId} THEN U.LAST_NAME || U.FIRST_NAME
                ELSE ' '
              END               AS userName
        FROM
              USER_RESERVE UR
              LEFT JOIN USERS U ON UR.USER_ID = U.USER_ID
        WHERE
              UR.PLACE_CD = #{placeCd}
          AND UR.CANCEL_YN = 'N'
          AND UR.START_AT &lt; #{endAt}
          AND UR.END_AT   &gt; #{startAt}
    </select>

    <!--
        강의실 배정 시간표(정규 수업) 조회
        - 설명: 특정 시설(placeCd)과 학기(yeartermCd)에 배정된 LCT_ROOM_SCHEDULE 목록을 조회합니다.
        - 파라미터:
            #{placeCd}    (String)
            #{yeartermCd} (String)
        - 결과 매핑: kr.or.jsu.vo.LctRoomScheduleVO (다건)
     -->
    <select id="selectLectureSchedulesByPlace" resultType="kr.or.jsu.vo.LctRoomScheduleVO">
        SELECT
              LRS.LECTURE_ID    AS lectureId
            , LRS.PLACE_CD      AS placeCd
            , LRS.TIMEBLOCK_CD  AS timeblockCd
        FROM
              LCT_ROOM_SCHEDULE LRS
              JOIN LECTURE L ON LRS.LECTURE_ID = L.LECTURE_ID
        WHERE
              LRS.PLACE_CD   = #{placeCd}
          AND L.YEARTERM_CD  = #{yeartermCd}
    </select>

    <!--
        시간블록 전체 조회
        - 설명: 요일/시작/종료 시각을 포함한 전체 TIMEBLOCK 정보를 조회합니다.
        - 파라미터: 없음
        - 결과 매핑: kr.or.jsu.vo.TimeblockVO (다건)
     -->
    <select id="selectAllTimeblocks" resultType="kr.or.jsu.vo.TimeblockVO">
        SELECT
              TIMEBLOCK_CD AS timeblockCd
            , WEEKDAY      AS weekday
            , START_HHMM   AS startHhmm
            , END_HHMM     AS endHhmm
        FROM
              TIMEBLOCK
    </select>

    <!--
        예약 취소 상태 변경
        - 설명: 본인 예약(RESERVE_ID, USER_ID 일치)에 한해 취소 상태로 변경합니다.
        - 파라미터:
            #{reserveId} (String)
            #{userId}    (String)
        - 반영: CANCEL_YN = 'Y'
        - 조건: 기존 상태가 'N'인 건만 업데이트
     -->
    <update id="updateReservationCancelStatus">
        UPDATE USER_RESERVE
           SET CANCEL_YN = 'Y'
         WHERE RESERVE_ID = #{reserveId}
           AND USER_ID    = #{userId}
           AND CANCEL_YN  = 'N'
    </update>

    <!--
        예약 단건 조회(본인/미취소)
        - 설명: 사용자가 소유한(RESERVE_ID, USER_ID 일치) 미취소(CANCEL_YN='N') 예약 단건을 조회합니다.
        - 파라미터:
            #{reserveId} (String)
            #{userId}    (String)
        - 결과 매핑: kr.or.jsu.vo.UserReserveVO (단건)
     -->
    <select id="selectReservation" resultType="kr.or.jsu.vo.UserReserveVO">
        SELECT
              RESERVE_ID     AS reserveId
            , PLACE_CD       AS placeCd
            , RESERVE_REASON AS reserveReason
            , CREATE_AT      AS createAt
            , START_AT       AS startAt
            , END_AT         AS endAt
            , HEADCOUNT      AS headcount
            , CANCEL_YN      AS cancelYn
            , USER_ID        AS userId
        FROM
              USER_RESERVE
        WHERE
              RESERVE_ID = #{reserveId}
          AND USER_ID    = #{userId}
          AND CANCEL_YN  = 'N'
    </select>

    <!--
        예약 정보 수정(본인/미취소)
        - 설명: 사용자가 소유한 미취소 예약의 사유/기간/인원 정보를 수정합니다.
        - 파라미터:
            #{reserveId}     (String)
            #{userId}        (String)
            #{reserveReason} (String)
            #{startAt}       (TIMESTAMP/DATE)
            #{endAt}         (TIMESTAMP/DATE)
            #{headcount}     (Number)
        - 조건: CANCEL_YN='N' 일 때만 수정
     -->
    <update id="updateReservation">
        UPDATE USER_RESERVE
           SET RESERVE_REASON = #{reserveReason}
             , START_AT       = #{startAt}
             , END_AT         = #{endAt}
             , HEADCOUNT      = #{headcount}
         WHERE RESERVE_ID     = #{reserveId}
           AND USER_ID        = #{userId}
           AND CANCEL_YN      = 'N'
    </update>

</mapper>
