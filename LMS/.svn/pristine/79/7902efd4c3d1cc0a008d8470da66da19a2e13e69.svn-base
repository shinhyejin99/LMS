<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.jsu.mybatis.mapper.LctIndivtaskMapper">

	<insert id="insertIndivtask">
		<selectKey keyProperty="indivtaskId" resultType="string" order="BEFORE">
			SELECT 'TSKINDV' || LPAD(TO_CHAR(SEQ_TASK_INDIV.NEXTVAL), 8, '0') AS INDIVTASK_ID
			FROM DUAL
		</selectKey>
		INSERT INTO LCT_INDIVTASK li (
			INDIVTASK_ID
			, LECTURE_ID
			, INDIVTASK_NAME
			, INDIVTASK_DESC
			, CREATE_AT
			, START_AT
			, END_AT
			, DELETE_YN
			, ATTACH_FILE_ID
		) VALUES(
			#{indivtaskId}
			, #{lectureId}
			, #{indivtaskName}
			, #{indivtaskDesc}
			, SYSDATE
			, #{startAt}
			, #{endAt}
			, 'N'
			, #{attachFileId}
		)
	</insert>

	<insert id="insertIndivtaskSubmit">
		INSERT ALL
		<foreach collection="enrollIds" item="enrollId">
			INTO INDIVTASK_SUBMIT (
				ENROLL_ID
				, INDIVTASK_ID
				, SUBMIT_DESC
				, SUBMIT_FILE_ID
				, SUBMIT_AT
				, EVALU_SCORE
				, EVALU_AT
				, EVALU_DESC
			) VALUES (
				#{enrollId}
				, #{indivtaskId}
				, NULL
				, NULL
				, NULL
				, NULL
				, NULL
				, NULL
			)
		</foreach>
		SELECT 1 FROM DUAL
	</insert>
	
	<select id="selectIndivtask">
		SELECT
			<include refid="indivtask_all_col"/>
		FROM
			LCT_INDIVTASK li
		WHERE
			li.INDIVTASK_ID = #{indivtaskId}
			AND DELETE_YN = 'N'
	</select>
	
	<select id="selectIndivtaskSubmit">
		SELECT
			  its.ENROLL_ID
			, its.INDIVTASK_ID
			, its.SUBMIT_DESC
			, its.SUBMIT_FILE_ID
			, its.SUBMIT_AT
			, its.EVALU_SCORE
			, its.EVALU_AT
			, its.EVALU_DESC
		FROM
			INDIVTASK_SUBMIT its
		WHERE
			its.INDIVTASK_ID = #{indivtaskId}
		<if test="@org.apache.commons.lang3.StringUtils@isNotBlank(enrollId)">
			AND its.ENROLL_ID = #{enrollId}
		</if>
	</select>
	
	<select id="selectIndivtaskList_PRF">
		SELECT
			<include refid="indivtask_all_col"/>
			, (
				SELECT count(*)
				FROM INDIVTASK_SUBMIT its
				WHERE its.INDIVTASK_ID = li.INDIVTASK_ID
				AND its.SUBMIT_AT IS NOT NULL
			) AS SUBMITTED_TASK
			, (
				SELECT count(*)
				FROM INDIVTASK_SUBMIT its
				WHERE its.INDIVTASK_ID = li.INDIVTASK_ID
			) AS TARGET_STUDENT_CNT
		FROM
			LCT_INDIVTASK li
		WHERE
			li.LECTURE_ID = #{lectureId}
			AND DELETE_YN = 'N'
	</select>
	
	<select id="selectIndivtaskList_STU">
		SELECT
			<include refid="indivtask_all_col"/>
			, CASE WHEN its.SUBMIT_AT IS NOT NULL THEN 1 ELSE 0 END AS IS_SUBMITTED
		FROM
			LCT_INDIVTASK li
		JOIN INDIVTASK_SUBMIT its ON
			its.INDIVTASK_ID = li.INDIVTASK_ID
			AND its.ENROLL_ID = #{enrollId}
		WHERE
			li.LECTURE_ID = #{lectureId}
			AND li.DELETE_YN = 'N'
	</select>
	
	<update id="deleteIndivtaskSoftly">
		UPDATE LCT_INDIVTASK li
		SET DELETE_YN = 'Y'
		WHERE li.INDIVTASK_ID = #{indivtaskId}
	</update>
	
	<update id="updateIndivtask">
		UPDATE
			LCT_INDIVTASK li
		SET
			li.INDIVTASK_NAME = #{indivtaskName}
			, li.INDIVTASK_DESC = #{indivtaskDesc}
			, li.START_AT = #{startAt}
			, li.END_AT = #{endAt}
			, li.ATTACH_FILE_ID = #{attachFileId}
		WHERE
			li.INDIVTASK_ID = #{indivtaskId}
	</update>
	
	<update id="updateIndivtaskSubmit">
	    UPDATE INDIVTASK_SUBMIT
	    <set>
	        <if test="submitDesc != null">
	            SUBMIT_DESC = #{submitDesc},
	        </if>
	        <if test="submitFileId != null">
	            SUBMIT_FILE_ID = #{submitFileId},
	        </if>
	        <if test="submitDesc != null or submitFileId != null">
	            SUBMIT_AT = SYSDATE,
	        </if>
	
	        <if test="evaluScore != null">
	            EVALU_SCORE = #{evaluScore},
	        </if>
	        <if test="evaluDesc != null">
	            EVALU_DESC = #{evaluDesc},
	        </if>
	        <if test="evaluScore != null or evaluDesc != null">
	            EVALU_AT = SYSDATE,
	        </if>
	    </set>
	    WHERE ENROLL_ID = #{enrollId}
	      AND INDIVTASK_ID = #{indivtaskId}
	</update>
	
	<select id="notSubmittedTaskList">
		SELECT
			  li.INDIVTASK_ID
			, li.LECTURE_ID
			, li.INDIVTASK_NAME
			, li.INDIVTASK_DESC
			, li.CREATE_AT
			, li.START_AT
			, li.END_AT
			, li.DELETE_YN
			, li.ATTACH_FILE_ID 
		FROM STUDENT s 
		JOIN STU_ENROLL_LCT sel ON
			s.STUDENT_NO = sel.STUDENT_NO
		JOIN LECTURE l ON
			sel.LECTURE_ID = l.LECTURE_ID
			AND l.END_AT IS NULL -- 종강되지 않은 강의만(종강된 강의의 마감없는 과제 노출 막기위해)
		JOIN LCT_INDIVTASK li ON 
			sel.LECTURE_ID = li.LECTURE_ID 
			AND li.START_AT &lt; SYSDATE -- 제출 기간 조건 1, 제출 기간이 시작된
			AND (li.END_AT IS NULL OR li.END_AT > SYSDATE) -- 제출 기간 조건 2, 마감없는 과제거나 아직 마감 기간인
			AND li.DELETE_YN = 'N' -- 과제 자체가 삭제되지 않은
		JOIN INDIVTASK_SUBMIT ivs ON
			li.INDIVTASK_ID = ivs.INDIVTASK_ID
			AND sel.ENROLL_ID = ivs.ENROLL_ID -- 학생에게 출제된 과제만
			AND ivs.SUBMIT_AT IS NULL -- 학생이 제출하지 않은
		WHERE s.STUDENT_NO = #{studentNo}
	</select>
	
	<resultMap type="NotEvaluatedIndivtaskDTO" id="needEvalTask" autoMapping="true">
		<association property="lecture" javaType="LectureInfo"
						columnPrefix="L_" autoMapping="true"/>
		<association property="indivtask" javaType="LctIndivtaskInfo"
						columnPrefix="LI_" autoMapping="true"/>
	</resultMap>
	
	<select id="notEvaluatedTaskList" resultMap="needEvalTask">
		SELECT
			  l.LECTURE_ID AS		L_LECTURE_ID
			, l.SUBJECT_CD AS		L_SUBJECT_CD
			, l.PROFESSOR_NO AS		L_PROFESSOR_NO
			, l.YEARTERM_CD AS		L_YEARTERM_CD
			, l.MAX_CAP AS			L_MAX_CAP
			, l.LECTURE_INDEX AS	L_LECTURE_INDEX
			, l.LECTURE_GOAL AS		L_LECTURE_GOAL
			, l.PREREQ_SUBJECT AS	L_PREREQ_SUBJECT
			, l.CANCEL_YN AS		L_CANCEL_YN
			, l.END_AT AS			L_END_AT
			, li.INDIVTASK_ID AS	LI_INDIVTASK_ID
			, li.LECTURE_ID AS		LI_LECTURE_ID
			, li.INDIVTASK_NAME AS	LI_INDIVTASK_NAME
			, li.INDIVTASK_DESC AS	LI_INDIVTASK_DESC
			, li.CREATE_AT AS		LI_CREATE_AT
			, li.START_AT AS		LI_START_AT
			, li.END_AT AS			LI_END_AT
			, li.DELETE_YN AS		LI_DELETE_YN
			, li.ATTACH_FILE_ID AS	LI_ATTACH_FILE_ID
			, NVL(pnd.PENDING_CNT, 0) AS SUBMIT_COUNT
		FROM PROFESSOR p
		JOIN LECTURE l ON
			p.PROFESSOR_NO = l.PROFESSOR_NO
			AND l.END_AT IS NULL
		JOIN LCT_INDIVTASK li ON
			l.LECTURE_ID = li.LECTURE_ID
		JOIN (
			SELECT
				INDIVTASK_ID
				, COUNT(*) AS PENDING_CNT
			FROM
				INDIVTASK_SUBMIT
			WHERE
				SUBMIT_AT IS NOT NULL
				AND EVALU_AT IS NULL
			GROUP BY
				INDIVTASK_ID
		) pnd ON
			pnd.INDIVTASK_ID = li.INDIVTASK_ID
			WHERE p.PROFESSOR_NO = #{professorNo}
	</select>

<sql id="indivtask_all_col">
  li.INDIVTASK_ID
, li.LECTURE_ID
, li.INDIVTASK_NAME
, li.INDIVTASK_DESC
, li.CREATE_AT
, li.START_AT
, li.END_AT
, li.DELETE_YN
, li.ATTACH_FILE_ID
</sql>
	
</mapper>