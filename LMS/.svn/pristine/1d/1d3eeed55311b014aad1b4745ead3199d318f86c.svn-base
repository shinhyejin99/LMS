<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.jsu.mybatis.mapper.UsersMapper">
<!--
 * == 개정이력(Modification Information) ==
 *
 *   수정일      			수정자           수정내용
 *  ============   	============== =======================
 *  2025. 9. 25.     	정태일        최초 생성
 *	2025. 9. 29.        최건우        업데이트 수정
 	2025.10. 01.        신혜진        등록시 userId 부여 방식 추가
 *	2025.10. 01.        송태호        코드 조각
-->
<sql id="users_min">
u.USER_ID
, u.FIRST_NAME
, u.LAST_NAME
, u.PHOTO_ID
, u.MOBILE_NO
, u.EMAIL
</sql>


<sql id="users_extra">
u.REGI_NO
, u.ADDR_ID
, u.BANK_CODE
, u.BANK_ACCOUNT
, u.CREATE_AT
</sql>

  <insert id="insertUser" parameterType="kr.or.jsu.vo.UsersVO">
    <selectKey keyProperty="userId" resultType="string" order="BEFORE">
        SELECT 'USER' || LPAD(TO_CHAR(SEQ_USER.NEXTVAL), 11, '0') FROM DUAL
    </selectKey>

    INSERT INTO USERS (
        USER_ID,
        PW_HASH,
        FIRST_NAME,
        LAST_NAME,
        REGI_NO,
        PHOTO_ID,
        ADDR_ID,
        MOBILE_NO,
        EMAIL,
        BANK_CODE,
        BANK_ACCOUNT,
        CREATE_AT
    ) VALUES (
        #{userId},
        #{pwHash},
        #{firstName},
        #{lastName},
        #{regiNo},
        #{photoId},
        #{addrId},
        #{mobileNo},
        #{email},
        #{bankCode},
        #{bankAccount},
        #{createAt}
    )
</insert>


  <select id="getNextUserIdSequenceBatch" resultType="string">
        SELECT
            'USER' || LPAD(TO_CHAR(SEQ_USER.NEXTVAL), 11, '0')
        FROM
            DUAL
        CONNECT BY LEVEL <![CDATA[ <= ]]> #{count}
    </select>

    <insert id="insertBatchUser">
        INSERT ALL
          <foreach collection="list" item="user" separator=" ">
            INTO USERS (
                USER_ID, PW_HASH, LAST_NAME, FIRST_NAME, REGI_NO,
                MOBILE_NO, EMAIL, BANK_CODE, BANK_ACCOUNT, ADDR_ID,
                CREATE_AT
            )
            VALUES (
                #{user.userId},  #{user.pwHash},
                #{user.lastName}, #{user.firstName}, #{user.regiNo},
                #{user.mobileNo}, #{user.email}, #{user.bankCode},
                #{user.bankAccount}, #{user.addrId},
                SYSDATE
            )
          </foreach>
        SELECT * FROM DUAL
    </insert>


   <select id="selectUser" resultType="kr.or.jsu.vo.UsersVO">
       SELECT
		<include refid="users_min"/>
       	, <include refid="users_extra"/>
		, u.PW_HASH
	FROM
		USERS u
       WHERE
           USER_ID = #{userId}
   </select>

   <select id="selectUserList" resultType="kr.or.jsu.vo.UsersVO">
       SELECT
       	<include refid="users_min"/>
       	, <include refid="users_extra"/>
		, u.PW_HASH
       FROM
           USERS u
       ORDER BY
           USER_ID
   </select>

    <select id="selectStaffUser" resultType="kr.or.jsu.vo.UsersVO">
        SELECT
			USER_ID
			, PW_HASH
			, FIRST_NAME
			, LAST_NAME
			, REGI_NO
			, PHOTO_ID
			, ADDR_ID
			, MOBILE_NO
			, EMAIL
			, BANK_CODE
			, BANK_ACCOUNT
			, CREATE_AT
		FROM
			USERS
        WHERE
            user_id = #{userId}
    </select>

    <select id="selectUserStaffList" resultType="kr.or.jsu.vo.UsersVO">
        SELECT
            USER_ID
			, PW_HASH
			, FIRST_NAME
			, LAST_NAME
			, REGI_NO
			, PHOTO_ID
			, ADDR_ID
			, MOBILE_NO
			, EMAIL
			, BANK_CODE
			, BANK_ACCOUNT
			, CREATE_AT
        FROM
            USERS
        ORDER BY
            user_id
    </select>

	<update id="updateUser" parameterType="kr.or.jsu.vo.UsersVO">
		UPDATE USERS
		<set>
			<if test="pwHash != null and pwHash != ''">PW_HASH = #{pwHash},</if>
			<if test="firstName != null and firstName != ''">FIRST_NAME = #{firstName},</if>
			<if test="lastName != null and lastName != ''">LAST_NAME = #{lastName},</if>
			<if test="regiNo != null and regiNo != ''">REGI_NO = #{regiNo},</if>
			<if test="photoId != null and photoId != ''">PHOTO_ID = #{photoId},</if>
			<if test="addrId != null and addrId != ''">ADDR_ID = #{addrId},</if>
			<if test="mobileNo != null and mobileNo != ''">MOBILE_NO = #{mobileNo},</if>
			<if test="email != null and email != ''">EMAIL = #{email},</if>
			<if test="bankCode != null and bankCode != ''">BANK_CODE = #{bankCode},</if>

			<if test="bankAccount != null and bankAccount != ''">BANK_ACCOUNT = #{bankAccount}</if>

            </set>
		WHERE
		    USER_ID = #{userId}
	</update>


	<delete id="deleteUser">
	    DELETE FROM USERS
	    WHERE
	        USER_ID = #{userId}
	</delete>
	
	<update id="updateUserPhotoId">
		UPDATE USERS
		SET PHOTO_ID = #{newPhotoId}
		WHERE USER_ID = #{finalUserId}
	</update>
</mapper>