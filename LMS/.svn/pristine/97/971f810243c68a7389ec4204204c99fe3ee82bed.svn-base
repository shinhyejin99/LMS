<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.jsu.mybatis.mapper.RecordApplyMapper">
<!--
 * == 개정이력(Modification Information) ==
 *
 *   수정일      			수정자           수정내용
 *  ============   	============== =======================
 *  2025. 10. 9.     	김수현            최초 생성
 *	2025. 10. 13.		김수현			중복 신청 방지 쿼리 추가
 *
-->

	<!-- 학적변동 신청 등록 (공통) : 학생_학적변동신청 테이블에 -->
	<insert id="insertRecordApply">
		<!-- APPLY_ID 생성 -->
		<selectKey keyProperty="applyId" resultType="string" order="BEFORE">
			SELECT 'APPLY' || LPAD(TO_CHAR(SEQ_APPLY.NEXTVAL), 10, '0') AS APPLY_ID
			FROM DUAL
		</selectKey>

		INSERT INTO UNIV_RECORD_APPLY (
			APPLY_ID
			, STUDENT_NO
			, RECORD_CHANGE_CD
			, DISIRE_TERM
			, APPLY_AT
			, APPLY_REASON
			, APPLY_STATUS_CD
			, ATTACH_FILE_ID
			, APPROVAL_LINE
		) VALUES (
			#{applyId}
			, #{studentNo}
			, #{recordChangeCd}
			, #{disireTerm}
			, SYSDATE
			, #{applyReason}
			, 'PENDING'
			, #{attachFileId}
			, #{approvalLine}
		)
	</insert>

	<!-- 학생) 신청 목록 조회 -->
	<select id="selectApplyListByStudent" resultType="kr.or.jsu.dto.RecordApplyResponseDTO">
		SELECT
			ra.APPLY_ID
			, ra.STUDENT_NO
			, u.FIRST_NAME || ' ' || u.LAST_NAME AS STUDENT_NAME
			, ra.RECORD_CHANGE_CD
			, cc1.CD_NAME AS RECORD_CHANGE_NAME
			, ra.DISIRE_TERM
			, ra.APPLY_AT
			, ra.APPLY_REASON
			, ra.APPLY_STATUS_CD
			, cc2.CD_NAME AS APPLY_STATUS_NAME
			, ra.APPROVAL_LINE
			, approver.LAST_NAME || approver.FIRST_NAME AS CURRENT_APPROVER_NAME
			                        , CASE
			                            WHEN ra.APPLY_STATUS_CD = 'APPROVED' THEN
			                                                                NVL(TO_CHAR(
			                                                                    (SELECT
			                                                                        MAX(AP_FINAL.APPROVE_AT) KEEP (DENSE_RANK LAST ORDER BY AP_FINAL.APPROVE_AT)
			                                                                    FROM
			                                                                        APPROVAL AP_FINAL
			                                                                    WHERE
			                                                                        AP_FINAL.APPLICANT_USER_ID = u.USER_ID
			                                                                        AND AP_FINAL.APPLY_TYPE_CD = 'UNIV_RECORD_CHANGE'
			                                                                        AND AP_FINAL.APPROVE_YNNULL = 'Y'
			                                                                        AND AP_FINAL.APPROVE_ID IN (
			                                                                            SELECT APPROVE_ID
			                                                                            FROM APPROVAL
			                                                                            START WITH APPROVE_ID = ra.APPROVAL_LINE
			                                                                            CONNECT BY PRIOR PREV_APPROVE_ID = APPROVE_ID
			                                                                        )
			                                                                    ), 'YYYY-MM-DD'
			                                                                ), '')
			                            ELSE NULL
			                          END AS APPROVE_AT		FROM
			UNIV_RECORD_APPLY ra
		JOIN STUDENT s ON ra.STUDENT_NO = s.STUDENT_NO
		JOIN USERS u ON s.USER_ID = u.USER_ID
		LEFT JOIN COMMON_CODE cc1 ON ra.RECORD_CHANGE_CD = cc1.COMMON_CD
		LEFT JOIN COMMON_CODE cc2 ON ra.APPLY_STATUS_CD = cc2.COMMON_CD
		LEFT JOIN APPROVAL ap ON ra.APPROVAL_LINE = ap.APPROVE_ID
	    LEFT JOIN USERS approver ON ap.USER_ID = approver.USER_ID
		WHERE
			ra.STUDENT_NO = #{studentNo}
		ORDER BY
			ra.APPLY_AT DESC
	</select>

	<!-- 신청 상세 조회 -->
	<select id="selectApplyDetail" resultType="kr.or.jsu.dto.RecordApplyResponseDTO">
		SELECT
			ra.APPLY_ID
			, ra.STUDENT_NO
			, u.FIRST_NAME || ' ' || u.LAST_NAME AS STUDENT_NAME
			, ra.RECORD_CHANGE_CD
			, cc1.CD_NAME AS RECORD_CHANGE_NAME
			, ra.DISIRE_TERM
			, ra.APPLY_AT
			, ra.APPLY_REASON
			, ra.APPLY_STATUS_CD
			 			, cc2.CD_NAME AS APPLY_STATUS_NAME
						, ra.ATTACH_FILE_ID
						, ra.APPROVAL_LINE
						, approver.LAST_NAME || approver.FIRST_NAME AS CURRENT_APPROVER_NAME -- 승인자 정보
						, ap.COMMENTS AS rejectionReason -- 반려사유
					FROM			UNIV_RECORD_APPLY ra
		JOIN
			STUDENT s ON ra.STUDENT_NO = s.STUDENT_NO
		JOIN
			USERS u ON s.USER_ID = u.USER_ID
		LEFT JOIN
			COMMON_CODE cc1 ON ra.RECORD_CHANGE_CD = cc1.COMMON_CD
		LEFT JOIN
			COMMON_CODE cc2 ON ra.APPLY_STATUS_CD = cc2.COMMON_CD
		-- 승인 라인
	    LEFT JOIN APPROVAL ap ON ra.APPROVAL_LINE = ap.APPROVE_ID
	    LEFT JOIN USERS approver ON ap.USER_ID = approver.USER_ID
		WHERE
			ra.APPLY_ID = #{applyId}
	</select>

	<!-- 신청 취소 (DELETE) -->
	<delete id="deleteApply">
		DELETE FROM UNIV_RECORD_APPLY
		WHERE
			APPLY_ID = #{applyId}
			AND APPLY_STATUS_CD = 'PENDING'
	</delete>


	<!-- 신청 상태 변경 (UPDATE) -->
	<update id="updateApplyStatus">
		UPDATE UNIV_RECORD_APPLY
		SET
			APPLY_STATUS_CD = #{applyStatusCd}
		WHERE
			APPLY_ID = #{applyId}
	</update>


	<!-- ======================== -->
	<!-- 신청 가능 여부 체크 -->
	<!-- ======================== -->

	<!-- 학생의 현재 학적 상태 조회 -->
	<select id="selectStudentStatus" resultType="string">
		SELECT
			STU_STATUS_CD
		FROM
			STUDENT
		WHERE
			STUDENT_NO = #{studentNo}
	</select>

	<!-- 학생의 진행중인 신청 개수 조회 (중복 신청 방지) -->
	<select id="countPendingApply" resultType="int">
		SELECT
			COUNT(*)
		FROM
			UNIV_RECORD_APPLY
		WHERE
			STUDENT_NO = #{studentNo}
			AND RECORD_CHANGE_CD = #{recordChangeCd}
			AND (
	          -- 휴학 관련은 모두 체크
	          (#{recordChangeCd} = 'REST' AND RECORD_CHANGE_CD LIKE 'REST%')
	          OR RECORD_CHANGE_CD = #{recordChangeCd}
	      )
	</select>

	<!-- 승인 절차 위한 -->
	<!-- 지도교수 USER_ID 조회 -->
	<select id="selectProfessorUserId" resultType="string">
	    SELECT u.USER_ID
	    FROM STUDENT s
	    JOIN PROFESSOR p ON s.PROFESSOR_ID = p.PROFESSOR_NO
	    JOIN USERS u ON p.USER_ID = u.USER_ID
	    WHERE s.STUDENT_NO = #{studentNo}
	</select>

	<!-- 학과장 USER_ID 조회 -->
	<select id="selectDeptHeadUserId" resultType="string">
	    SELECT u.USER_ID
	    FROM PROFESSOR p
	    JOIN USERS u ON p.USER_ID = u.USER_ID
	    WHERE p.UNIV_DEPT_CD = #{deptCd}
	      AND p.PRF_POSIT_CD = 'HEAD'
	</select>

	<!-- 중복 신청 방지 -->
	<!-- 휴학 신청 중복 확인 -->
	<select id="existsPendingLeave" resultType="boolean">
	    SELECT COUNT(*) > 0
	    FROM UNIV_RECORD_APPLY
	    WHERE STUDENT_NO = #{studentNo}
	      AND RECORD_CHANGE_CD = 'REST'
	      AND APPLY_STATUS_CD = 'PENDING'
	</select>

	<!-- 복학 신청 중복 확인 -->
	<select id="existsPendingReturn" resultType="boolean">
	    SELECT COUNT(*) > 0
	    FROM UNIV_RECORD_APPLY
	    WHERE STUDENT_NO = #{studentNo}
	      AND RECORD_CHANGE_CD = 'RTRN'
	      AND APPLY_STATUS_CD = 'PENDING'
	</select>

	<!-- 졸업유예 신청 중복 확인 -->
	<select id="existsPendingDefer" resultType="boolean">
	    SELECT COUNT(*) > 0
	    FROM UNIV_RECORD_APPLY
	    WHERE STUDENT_NO = #{studentNo}
	      AND RECORD_CHANGE_CD = 'DEFR'
	      AND APPLY_STATUS_CD = 'PENDING'
	</select>


</mapper>