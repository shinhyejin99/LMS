<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.jsu.mybatis.mapper.UserReserveMapper">

    <!-- UserReserveVO 결과 매핑 정의 -->
    <resultMap id="userReserveMap" type="kr.or.jsu.vo.UserReserveVO">
        <id property="reserveId" column="RESERVE_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="placeCd" column="PLACE_CD"/>
        <result property="reserveReason" column="RESERVE_REASON"/>
        <result property="createAt" column="CREATE_AT"/>
        <result property="startAt" column="START_AT"/>
        <result property="endAt" column="END_AT"/>
        <result property="headcount" column="HEADCOUNT"/>
        <result property="cancelYn" column="CANCEL_YN"/>
        <!-- PLACE 테이블의 PLACE_NAME을 UserReserveVO의 placeName 필드에 매핑 -->
        <result property="placeName" column="PLACE_NAME"/>
        <!-- USERS 테이블의 USER_NAME을 UserReserveVO의 userName 필드에 매핑 -->
        <result property="userName" column="USER_NAME"/>
    </resultMap>

    <!-- 모든 사용자 시설 예약 정보를 조회하는 쿼리 -->
    <select id="selectAllUserReserves" resultMap="userReserveMap">
        SELECT
            ur.RESERVE_ID,
            ur.USER_ID,
            ur.PLACE_CD,
            ur.RESERVE_REASON,
            ur.CREATE_AT,
            ur.START_AT,
            ur.END_AT,
            ur.HEADCOUNT,
            ur.CANCEL_YN,
            p.PLACE_NAME,
            u.LAST_NAME || u.FIRST_NAME AS USER_NAME
        FROM
            USER_RESERVE ur
        JOIN
            PLACE p ON ur.PLACE_CD = p.PLACE_CD
        JOIN
            USERS u ON ur.USER_ID = u.USER_ID
        ORDER BY
            ur.CREATE_AT DESC
    </select>

    <!-- 새로운 사용자 시설 예약을 등록하는 쿼리 -->
    <insert id="insertUserReserve" parameterType="kr.or.jsu.vo.UserReserveVO">
        <selectKey keyProperty="reserveId" resultType="string" order="BEFORE">
            SELECT 'RESV-' || LPAD(SEQ_USER_RESERVE.NEXTVAL, 10, '0') FROM DUAL
        </selectKey>
        INSERT INTO USER_RESERVE (
            RESERVE_ID, USER_ID, PLACE_CD, RESERVE_REASON, CREATE_AT, START_AT, END_AT, HEADCOUNT, CANCEL_YN
        ) VALUES (
            #{reserveId}, #{userId}, #{placeCd}, #{reserveReason}, #{createAt}, #{startAt}, #{endAt}, #{headcount}, #{cancelYn}
        )
    </insert>

    <!-- 특정 사용자의 모든 예약 목록을 조회하는 쿼리 -->
    <select id="selectMyReservations" parameterType="string" resultMap="userReserveMap">
        SELECT
            ur.RESERVE_ID,
            ur.USER_ID,
            ur.PLACE_CD,
            ur.RESERVE_REASON,
            ur.CREATE_AT,
            ur.START_AT,
            ur.END_AT,
            ur.HEADCOUNT,
            ur.CANCEL_YN,
            p.PLACE_NAME,
            u.LAST_NAME || u.FIRST_NAME AS USER_NAME
        FROM
            USER_RESERVE ur
        JOIN
            PLACE p ON ur.PLACE_CD = p.PLACE_CD
        JOIN
            USERS u ON ur.USER_ID = u.USER_ID
        WHERE
            ur.USER_ID = #{userId}
        ORDER BY
            ur.CREATE_AT DESC
    </select>

    <!-- 모든 사용자 시설 예약 정보를 조회하는 쿼리 (StaffUserReserveService용) -->
    <select id="selectUserReservesList" parameterType="string" resultMap="userReserveMap">
        SELECT
            ur.RESERVE_ID,
            ur.USER_ID,
            ur.PLACE_CD,
            ur.RESERVE_REASON,
            ur.CREATE_AT,
            ur.START_AT,
            ur.END_AT,
            ur.HEADCOUNT,
            ur.CANCEL_YN,
            p.PLACE_NAME,
            u.LAST_NAME || u.FIRST_NAME AS USER_NAME
        FROM
            USER_RESERVE ur
        JOIN
            PLACE p ON ur.PLACE_CD = p.PLACE_CD
        JOIN
            USERS u ON ur.USER_ID = u.USER_ID
        <where>
            <if test="searchTerm != null and searchTerm != ''">
                AND (
                    p.PLACE_NAME LIKE '%' || #{searchTerm} || '%'
                    OR u.LAST_NAME || u.FIRST_NAME LIKE '%' || #{searchTerm} || '%'
                )
            </if>
        </where>
        ORDER BY
            ur.CREATE_AT DESC
    </select>

    <!-- 특정 예약 ID로 사용자 시설 예약 정보를 조회하는 쿼리 -->
    <select id="selectUserReserve" parameterType="string" resultMap="userReserveMap">
        SELECT
            ur.RESERVE_ID,
            ur.USER_ID,
            ur.PLACE_CD,
            ur.RESERVE_REASON,
            ur.CREATE_AT,
            ur.START_AT,
            ur.END_AT,
            ur.HEADCOUNT,
            ur.CANCEL_YN,
            p.PLACE_NAME,
            u.LAST_NAME || u.FIRST_NAME AS USER_NAME
        FROM
            USER_RESERVE ur
        JOIN
            PLACE p ON ur.PLACE_CD = p.PLACE_CD
        JOIN
            USERS u ON ur.USER_ID = u.USER_ID
        WHERE
            ur.RESERVE_ID = #{reserveId}
    </select>

    <!-- 사용자 시설 예약 정보를 수정하는 쿼리 -->
    <update id="updateUserReserve" parameterType="kr.or.jsu.vo.UserReserveVO">
        UPDATE USER_RESERVE
        SET
            RESERVE_REASON = #{reserveReason},
            START_AT = #{startAt},
            END_AT = #{endAt},
            HEADCOUNT = #{headcount},
            CANCEL_YN = #{cancelYn}
        WHERE
            RESERVE_ID = #{reserveId}
    </update>

	<select id="selectTotalReservableSlots" resultType="int">
       SELECT
        COUNT(PLACE_CD)
    FROM
        PLACE
    </select>

    <select id="selectConfirmedReservationSlots" resultType="int">
        SELECT
        COUNT(RESERVE_ID)
    FROM
        USER_RESERVE
    WHERE
        CANCEL_YN = 'N'
    </select>
</mapper>
