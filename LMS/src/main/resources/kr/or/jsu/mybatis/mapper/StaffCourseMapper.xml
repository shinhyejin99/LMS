<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.jsu.mybatis.mapper.StaffCourseMapper">
	<!-- 강의 통계 조회 -->
    <select id="selectCourseStats" resultType="kr.or.jsu.classregist.dto.StaffCourseStatsDTO">
        SELECT
            COUNT(*) AS totalLectures,
            NVL(SUM(CURRENT_ENROLL), 0) AS totalStudents,
            CASE
                WHEN SUM(MAX_CAP) > 0
                THEN ROUND(SUM(CURRENT_ENROLL) / SUM(MAX_CAP), 3)
                ELSE 0
            END AS avgEnrollRate
        FROM (
            SELECT
                L.LECTURE_ID,
                L.MAX_CAP,
                (SELECT COUNT(*) FROM STU_APPLY_LCT SAL WHERE SAL.LECTURE_ID = L.LECTURE_ID) AS CURRENT_ENROLL
            FROM LECTURE L
            WHERE L.YEARTERM_CD = #{yeartermCd}
              AND L.CANCEL_YN = 'N'
        )
    </select>

    <!-- 강의 목록 조회 (검색 + 페이징) -->
    <select id="selectCourseList" resultType="kr.or.jsu.classregist.dto.LectureListDTO">
        SELECT * FROM (
            SELECT
                L.LECTURE_ID,
                S.SUBJECT_NAME,
                U.LAST_NAME || U.FIRST_NAME AS PROFESSOR_NAME,
                (
                    SELECT DISTINCT PLACE_NAME
                    FROM LCT_ROOM_SCHEDULE LRS2
                    JOIN PLACE PL2 ON LRS2.PLACE_CD = PL2.PLACE_CD
                    WHERE LRS2.LECTURE_ID = L.LECTURE_ID
                    AND ROWNUM = 1
                ) AS PLACE_NAME,
                (
                    SELECT LISTAGG(
                        CASE TB.WEEKDAY
                            WHEN 'MO' THEN '월'
                            WHEN 'TU' THEN '화'
                            WHEN 'WE' THEN '수'
                            WHEN 'TH' THEN '목'
                            WHEN 'FR' THEN '금'
                        END || ' ' ||
                        MIN(TRUNC((TO_NUMBER(SUBSTR(TB.START_HHMM, 1, 2)) - 9) + (TO_NUMBER(SUBSTR(TB.START_HHMM, 3, 2)) / 60)) + 1) ||
                        '-' ||
                        MAX(TRUNC((TO_NUMBER(SUBSTR(TB.END_HHMM, 1, 2)) - 9) + (TO_NUMBER(SUBSTR(TB.END_HHMM, 3, 2)) / 60))),
                        ', '
                    ) WITHIN GROUP (ORDER BY TB.WEEKDAY)
                    FROM (
                        SELECT DISTINCT WEEKDAY, START_HHMM, END_HHMM
                        FROM LCT_ROOM_SCHEDULE LRS2
                        JOIN TIMEBLOCK TB2 ON LRS2.TIMEBLOCK_CD = TB2.TIMEBLOCK_CD
                        WHERE LRS2.LECTURE_ID = L.LECTURE_ID
                    ) TB
                    GROUP BY TB.WEEKDAY
                ) AS TIME_INFO,
                S.CREDIT,
                S.HOUR,
                CC.CD_NAME AS COMPLETION_NAME,
                L.MAX_CAP,
                NVL(
                    (
                        SELECT LISTAGG(
                            DISTINCT
                            CASE ST.GRADE_CD
                                WHEN '1ST' THEN '1'
                                WHEN '2ND' THEN '2'
                                WHEN '3RD' THEN '3'
                                WHEN '4TH' THEN '4'
                            END || '학년',
                            ', '
                        ) WITHIN GROUP (ORDER BY ST.GRADE_CD)
                        FROM SBJ_TARGET ST
                        WHERE ST.SUBJECT_CD = L.SUBJECT_CD
                    ),
                    '전학년'
                ) AS TARGET_GRADES,
                (SELECT COUNT(*) FROM STU_APPLY_LCT SAL WHERE SAL.LECTURE_ID = L.LECTURE_ID) AS CURRENT_ENROLL,
                CASE
                    WHEN L.MAX_CAP > 0
                    THEN ROUND((SELECT COUNT(*) FROM STU_APPLY_LCT SAL WHERE SAL.LECTURE_ID = L.LECTURE_ID) / L.MAX_CAP * 100, 1)
                    ELSE 0
                END AS ENROLL_RATE,
                ROW_NUMBER() OVER (ORDER BY L.LECTURE_ID) AS RN
            FROM LECTURE L
            JOIN SUBJECT S ON L.SUBJECT_CD = S.SUBJECT_CD
            JOIN PROFESSOR P ON L.PROFESSOR_NO = P.PROFESSOR_NO
            JOIN USERS U ON P.USER_ID = U.USER_ID
            LEFT JOIN COMMON_CODE CC ON S.COMPLETION_CD = CC.COMMON_CD
            WHERE L.CANCEL_YN = 'N'
              AND L.YEARTERM_CD = #{searchDTO.yeartermCd}
              <!-- 통합 검색 (강의명 또는 교수명) -->
              <if test="searchDTO.searchKeyword != null and searchDTO.searchKeyword != ''">
                  AND (
                      S.SUBJECT_NAME LIKE '%' || #{searchDTO.searchKeyword} || '%'
                      OR (U.LAST_NAME || U.FIRST_NAME) LIKE '%' || #{searchDTO.searchKeyword} || '%'
                  )
              </if>
        )
        WHERE RN BETWEEN #{searchDTO.offset} + 1 AND #{searchDTO.offset} + #{searchDTO.pageSize}
    </select>

    <!-- 강의 총 개수 (검색 결과 카운트) -->
    <select id="countCourseList" resultType="int">
        SELECT COUNT(*)
        FROM LECTURE L
        JOIN SUBJECT S ON L.SUBJECT_CD = S.SUBJECT_CD
        JOIN PROFESSOR P ON L.PROFESSOR_NO = P.PROFESSOR_NO
        JOIN USERS U ON P.USER_ID = U.USER_ID
        WHERE L.CANCEL_YN = 'N'
          AND L.YEARTERM_CD = #{searchDTO.yeartermCd}
          <if test="searchDTO.searchKeyword != null and searchDTO.searchKeyword != ''">
              AND (
                  S.SUBJECT_NAME LIKE '%' || #{searchDTO.searchKeyword} || '%'
                  OR (U.LAST_NAME || U.FIRST_NAME) LIKE '%' || #{searchDTO.searchKeyword} || '%'
              )
          </if>
    </select>

    <!-- 수강신청 확정 (학생_수강 테이블에 삽입)-->
    <insert id="confirmEnrollment">
        -- 이미 등록된 학생 제외하고 INSERT
		INSERT INTO STU_ENROLL_LCT (
		    ENROLL_ID,
		    STUDENT_NO,
		    LECTURE_ID,
		    ENROLL_STATUS_CD,
		    RETAKE_YN,
		    STATUS_CHANGE_AT,
		    AUTO_GRADE,
		    FINAL_GRADE,
		    CHANGE_REASON
		)
		SELECT
		    'STENRL' || LPAD(TO_CHAR(SEQ_STU_LCT_APPLY.NEXTVAL), 9, '0') AS ENROLL_ID,
		    SAL.STUDENT_NO,
		    SAL.LECTURE_ID,
		    'ENR_ING' AS ENROLL_STATUS_CD,
		    CASE
		        WHEN EXISTS (
		            SELECT 1
		            FROM STU_ENROLL_LCT SEL
		            WHERE SEL.STUDENT_NO = SAL.STUDENT_NO
		              AND SEL.LECTURE_ID = SAL.LECTURE_ID
		        ) THEN 'Y'
		        ELSE 'N'
		    END AS RETAKE_YN,
		    SYSDATE AS STATUS_CHANGE_AT,
		    NULL AS AUTO_GRADE,
		    NULL AS FINAL_GRADE,
		    NULL AS CHANGE_REASON
		FROM STU_APPLY_LCT SAL
		WHERE SAL.LECTURE_ID IN (
		    SELECT L.LECTURE_ID
		    FROM LECTURE L
		    WHERE L.YEARTERM_CD = '2026_REG1'
		)
		AND NOT EXISTS (  -- 이미 등록된 학생 제외
		    SELECT 1
		    FROM STU_ENROLL_LCT SEL
		    WHERE SEL.STUDENT_NO = SAL.STUDENT_NO
		      AND SEL.LECTURE_ID = SAL.LECTURE_ID
		)
    </insert>

    <!-- 수강신청 통계 조회 (확정용) -->
    <select id="getApplyStatistics" resultType="java.util.HashMap">
        SELECT
            COUNT(DISTINCT SAL.STUDENT_NO) AS totalStudents,
            COUNT(*) AS totalApplies,
            COUNT(DISTINCT SAL.LECTURE_ID) AS totalLectures
        FROM STU_APPLY_LCT SAL
        WHERE SAL.LECTURE_ID IN (
            SELECT L.LECTURE_ID
            FROM LECTURE L
            WHERE L.YEARTERM_CD = #{yeartermCd}
        )
    </select>

	<!-- 확정된 학생 USER_ID 목록 조회 -->
	<select id="selectConfirmedStudents" parameterType="string" resultType="string">
	    SELECT DISTINCT S.USER_ID
		  FROM STUDENT S
			  JOIN STU_ENROLL_LCT SEL ON S.STUDENT_NO = SEL.STUDENT_NO
			  JOIN LECTURE L ON SEL.LECTURE_ID = L.LECTURE_ID
		  WHERE L.YEARTERM_CD = #{yeartermCd}
   			 AND L.CANCEL_YN = 'N'
	</select>

	<!-- 해당 학기 강의 담당 교수 USER_ID 목록 조회 -->
	<select id="selectProfessorsForTerm" parameterType="string" resultType="string">
	    SELECT DISTINCT P.USER_ID
	    FROM LECTURE L
	    JOIN PROFESSOR P ON L.PROFESSOR_NO = P.PROFESSOR_NO
	    WHERE L.YEARTERM_CD = #{yeartermCd}
	      AND L.PROFESSOR_NO IS NOT NULL
	      AND L.CANCEL_YN = 'N'
	</select>

</mapper>