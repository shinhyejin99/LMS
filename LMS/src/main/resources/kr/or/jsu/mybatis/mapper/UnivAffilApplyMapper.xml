<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
 * == 개정이력(Modification Information) ==
 *
 *   수정일      			수정자           수정내용
 *  ============   	============== =======================
 *  2025. 10. 14.     	김수현            소속변경 신청 관련 추가
 *
-->
<mapper namespace="kr.or.jsu.mybatis.mapper.UnivAffilApplyMapper">

	<!-- 소속변경 신청 등록 -->
    <insert id="insertAffilApply">
        <selectKey keyProperty="applyId" resultType="string" order="BEFORE">
            SELECT 'AFFIL' || LPAD(SEQ_AFFIL_APPLY.NEXTVAL, 10, '0') FROM DUAL
        </selectKey>

        INSERT INTO univ_affil_apply (
            APPLY_ID
            , STUDENT_NO
            , TARGET_DEPT_CD
            , AFFIL_CHANGE_CD
            , APPLY_AT
            , APPLY_REASON
            , APPLY_STATUS_CD
            , ATTACH_FILE_ID
            , APPROVAL_LINE
        ) VALUES (
            #{applyId}
            , #{studentNo}
            , #{targetDeptCd}
            , #{affilChangeCd}
            , SYSDATE
            , #{applyReason}
            , 'PENDING'
            , #{attachFileId}
            , #{approvalLine}
        )
    </insert>

    <!-- 학생의 소속변경 신청 목록 조회 -->
    <select id="selectApplyListByStudent" resultType="kr.or.jsu.dto.AffilApplyResponseDTO">
        SELECT
            aa.APPLY_ID
            , aa.STUDENT_NO
            , u.FIRST_NAME || ' ' || u.LAST_NAME AS STUDENT_NAME
            , aa.TARGET_DEPT_CD
            , ud.UNIV_DEPT_NAME AS TARGET_DEPT_NAME
            , aa.AFFIL_CHANGE_CD
            , cc1.CD_NAME AS AFFIL_CHANGE_NAME
            , aa.APPLY_AT
            , aa.APPLY_REASON
            , aa.APPLY_STATUS_CD
            , cc2.CD_NAME AS APPLY_STATUS_NAME
            , aa.APPROVAL_LINE
        	, approver.LAST_NAME || approver.FIRST_NAME AS CURRENT_APPROVER_NAME
        	        , CASE
        	            WHEN aa.APPLY_STATUS_CD = 'APPROVED' THEN
        	                TO_CHAR(
        	                    (SELECT
        	                        MAX(AP_FINAL.APPROVE_AT) KEEP (DENSE_RANK LAST ORDER BY AP_FINAL.APPROVE_AT)
        	                    FROM
        	                        APPROVAL AP_FINAL
        	                    WHERE
        	                        AP_FINAL.APPLICANT_USER_ID = u.USER_ID
        	                        AND AP_FINAL.APPLY_TYPE_CD = 'UNIV_AFFIL_CHANGE'
        	                        AND AP_FINAL.APPROVE_YNNULL = 'Y'
        	                        AND AP_FINAL.APPROVE_ID IN (
        	                            SELECT APPROVE_ID
        	                            FROM APPROVAL
        	                            START WITH APPROVE_ID = aa.APPROVAL_LINE
        	                            CONNECT BY PRIOR PREV_APPROVE_ID = APPROVE_ID
        	                        )
        	                    ), 'YYYY-MM-DD'
        	                )
        	            ELSE NULL
        	          END AS APPROVE_AT        FROM
        	UNIV_AFFIL_APPLY aa
        JOIN STUDENT s ON aa.STUDENT_NO = s.STUDENT_NO
        JOIN USERS u ON s.USER_ID = u.USER_ID
        JOIN UNIV_DEPT ud ON aa.TARGET_DEPT_CD = ud.UNIV_DEPT_CD
        LEFT JOIN COMMON_CODE cc1 ON aa.AFFIL_CHANGE_CD = cc1.COMMON_CD
        LEFT JOIN COMMON_CODE cc2 ON aa.APPLY_STATUS_CD = cc2.COMMON_CD
        LEFT JOIN APPROVAL ap ON aa.APPROVAL_LINE = ap.APPROVE_ID
    	LEFT JOIN USERS approver ON ap.USER_ID = approver.USER_ID
        WHERE
        	aa.STUDENT_NO = #{studentNo}
        ORDER BY aa.APPLY_AT DESC
    </select>

    <!-- 소속변경 신청 상세 조회 -->
    <select id="selectApplyDetail" resultType="kr.or.jsu.dto.AffilApplyResponseDTO">
        SELECT
            aa.APPLY_ID
            , aa.STUDENT_NO
            , u.FIRST_NAME || ' ' || u.LAST_NAME AS STUDENT_NAME
            , aa.TARGET_DEPT_CD
            , ud.UNIV_DEPT_NAME AS TARGET_DEPT_NAME
            , c.COLLEGE_NAME AS TARGET_COLLEGE_NAME
            , aa.AFFIL_CHANGE_CD
            , cc1.CD_NAME AS AFFIL_CHANGE_NAME
            , aa.APPLY_AT
            , aa.APPLY_REASON
            , aa.APPLY_STATUS_CD
            , cc2.CD_NAME AS APPLY_STATUS_NAME
            , aa.ATTACH_FILE_ID
            , aa.APPROVAL_LINE
            , approver.LAST_NAME || approver.FIRST_NAME AS CURRENT_APPROVER_NAME
            , ap.COMMENTS AS rejectionReason -- 반려사유
        FROM
        	UNIV_AFFIL_APPLY aa
        JOIN STUDENT s ON aa.STUDENT_NO = s.STUDENT_NO
        JOIN USERS u ON s.USER_ID = u.USER_ID
        JOIN UNIV_DEPT ud ON aa.TARGET_DEPT_CD = ud.UNIV_DEPT_CD
        JOIN COLLEGE c ON ud.COLLEGE_CD = c.COLLEGE_CD
        LEFT JOIN COMMON_CODE cc1 ON aa.AFFIL_CHANGE_CD = cc1.COMMON_CD
        LEFT JOIN COMMON_CODE cc2 ON aa.APPLY_STATUS_CD = cc2.COMMON_CD
        LEFT JOIN APPROVAL ap ON aa.APPROVAL_LINE = ap.APPROVE_ID
        LEFT JOIN USERS approver ON ap.USER_ID = approver.USER_ID
        WHERE
        	aa.APPLY_ID = #{applyId}
    </select>

    <!-- 소속변경 신청 삭제 -->
    <delete id="deleteApply">
        DELETE FROM UNIV_AFFIL_APPLY
        WHERE APPLY_ID = #{applyId}
    </delete>

    <!-- 중복 신청 확인 -->
    <select id="countPendingApply" resultType="int">
        SELECT COUNT(*)
        FROM UNIV_AFFIL_APPLY
        WHERE STUDENT_NO = #{studentNo}
          AND AFFIL_CHANGE_CD = #{affilChangeCd}
          AND APPLY_STATUS_CD = 'PENDING'
    </select>

    <!-- 같은 단과대학 내 학과 목록 조회 (전과용) -->
    <select id="selectSameCollegeDepts" resultType="kr.or.jsu.core.dto.info.UnivDeptInfo">
        SELECT
            ud.UNIV_DEPT_CD
            , ud.UNIV_DEPT_NAME
            , ud.COLLEGE_CD
            , c.COLLEGE_NAME
        FROM
        	UNIV_DEPT ud
        JOIN COLLEGE c ON ud.COLLEGE_CD = c.COLLEGE_CD
        WHERE ud.COLLEGE_CD = (
            SELECT
            	ud2.COLLEGE_CD
            FROM
            	STUDENT s
            JOIN UNIV_DEPT ud2 ON s.UNIV_DEPT_CD = ud2.UNIV_DEPT_CD
            WHERE
            	s.STUDENT_NO = #{studentNo}
        )
        AND ud.UNIV_DEPT_CD != (
            SELECT UNIV_DEPT_CD FROM STUDENT WHERE STUDENT_NO = #{studentNo}
        )
        ORDER BY ud.UNIV_DEPT_NAME
    </select>

    <!-- 전체 학과 목록 조회 (복수전공/부전공용) -->
    <select id="selectAllDepts" resultType="kr.or.jsu.core.dto.info.UnivDeptInfo">
        SELECT
            ud.UNIV_DEPT_CD
            , ud.UNIV_DEPT_NAME
            , ud.COLLEGE_CD
            , c.COLLEGE_NAME
        FROM
        	UNIV_DEPT ud
        JOIN COLLEGE c ON ud.COLLEGE_CD = c.COLLEGE_CD
        WHERE ud.UNIV_DEPT_CD != (
            SELECT UNIV_DEPT_CD FROM STUDENT WHERE STUDENT_NO = #{studentNo}
        )
        ORDER BY c.COLLEGE_NAME, ud.UNIV_DEPT_NAME
    </select>

</mapper>
